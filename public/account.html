<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>My Account - YourPilates.Phuket</title>

    <!-- Link to your existing core CSS file -->
    <link rel="stylesheet" href="new_styles.css" />

    <!-- Optional: Link to a specific CSS file for account/modal styling if you create one -->
    <link rel="stylesheet" href="path/to/your/account-modal-styles.css" />
  </head>
  <body>
    <!-- Include your website's header/navigation here -->
    <header>
      <!-- Your site's header content, including the navigation link to account.html -->
      <nav>
        <ul>
          <li><a href="index.html">Home</a></li>
          <!-- Add other navigation links specific to your site -->
          <li><a href="account.html">Account</a></li>
          <!-- ENSURE THIS LINK EXISTS IN YOUR SITE'S NAVIGATION -->
        </ul>
      </nav>
    </header>

    <main>
      <!-- Content that requires authentication -->
      <!-- This div will be shown/hidden by JavaScript -->
      <section id="account-content">
        <h1>My Account</h1>
        <p id="welcome-message">Welcome, User!</p>
        <p>
          Your current credit balance:
          <strong id="credit-balance">Loading...</strong>
        </p>

        <!-- Purchase Credits Form -->
        <section id="purchase-credits-section">
          <h2>Purchase Credits</h2>
          <form id="purchase-credits-form">
            <div>
              <label for="credit-package">Select Package:</label>
              <select id="credit-package" name="credit-package" required>
                <option value="" disabled selected>--Choose a package--</option>
                <option value="package1">10 Credits - 500 THB</option>
                <option value="package2">
                  25 Credits - 1125 THB (10% off)
                </option>
                <option value="package3">
                  50 Credits - 2000 THB (20% off)
                </option>
              </select>
            </div>
            <div>
              <label for="payment-proof">Upload Payment Proof (Image):</label>
              <input
                type="file"
                id="payment-proof"
                name="payment-proof"
                accept="image/*"
                required
              />
            </div>
            <button type="submit" id="submit-purchase-request">
              Submit Purchase Request
            </button>
            <p id="purchase-message"></p>
            <!-- For success/error messages -->
          </form>
        </section>
        <!-- End Purchase Credits Form -->

        <h2>Available Booking Slots</h2>
        <div id="available-slots-list">
          <p>Loading available slots...</p>
          <!-- Available slots will be loaded here by JavaScript -->
        </div>

        <button id="logout-button">Logout</button>
      </section>

      <!-- Authentication Modal -->
      <!-- This div will be shown/hidden by JavaScript -->
      <div id="auth-modal" class="modal-overlay" style="display: none">
        <div class="modal-content">
          <!-- Login Form Container -->
          <div id="login-form-container">
            <h2>Login to Your Account</h2>
            <form id="login-form">
              <input
                type="email"
                id="login-email"
                placeholder="Email"
                required
              />
              <input
                type="password"
                id="login-password"
                placeholder="Password"
                required
              />
              <button type="submit">Login</button>
            </form>
            <p id="auth-error-message"></p>
            <!-- Error message display -->
            <p class="modal-toggle-link" data-target="register-form-container">
              Need an account? Register here.
            </p>
          </div>

          <!-- Registration Form Container (initially hidden) -->
          <div id="register-form-container" style="display: none">
            <h2>Register for an Account</h2>
            <form id="register-form">
              <input
                type="text"
                id="register-name"
                placeholder="Your Name (Optional)"
              />
              <input
                type="email"
                id="register-email"
                placeholder="Email"
                required
              />
              <input
                type="password"
                id="register-password"
                placeholder="Password"
                required
              />
              <button type="submit">Register</button>
            </form>
            <p id="auth-reg-error-message"></p>
            <!-- Registration error message display -->
            <p class="modal-toggle-link" data-target="login-form-container">
              Already have an account? Login here.
            </p>
          </div>

          <!-- Optional: Google Sign-In button -->
          <!-- Uncomment and style this if you want to add Google Sign-In -->
          <!-- <button id="google-signin-button">Sign in with Google</button> -->
        </div>
      </div>
    </main>

    <!-- Include your website's footer here -->
    <footer>
      <!-- Your site's footer content -->
    </footer>

    <!--
        Initialize Firebase using the modular SDK.
        This script should come AFTER all the HTML elements it might interact with,
        but BEFORE any other scripts that depend on Firebase being initialized
        and service instances being globally available (if you use that approach).
    -->
    <script type="module">
      // Import the functions you need from the SDKs you need
      // Use the specific version you prefer (e.g., 9.22.2 or 11.7.3)
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
      import {
        getAuth,
        onAuthStateChanged,
        signInWithEmailAndPassword,
        createUserWithEmailAndPassword,
        signOut,
      } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
      import {
        getFirestore,
        doc,
        getDoc,
        collection,
        query,
        where,
        orderBy,
        getDocs,
        runTransaction,
        setDoc, // Added setDoc for creating user document on registration
        serverTimestamp, // Import serverTimestamp
      } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";
      import {
        getFunctions,
        httpsCallable,
      } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-functions.js";
      import {
        getStorage,
        ref as storageRef, // Use 'ref as storageRef' to avoid conflict with 'ref' from Firestore if you use it elsewhere
        uploadBytesResumable,
        getDownloadURL,
      } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-storage.js";
      // import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-analytics.js"; // Uncomment if you need analytics

      // Your web app's Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyDVx5hMUh6euQ1M7zF7tAo1nr_Kv4D17jE",
        authDomain: "yourpilatesphuket.firebaseapp.com",
        projectId: "yourpilatesphuket",
        storageBucket: "yourpilatesphuket.firebasestorage.app",
        messagingSenderId: "452901193256",
        appId: "1:452901193256:web:18997b96ad7152ccad571d",
        measurementId: "G-PR8WTBM61S", // <--- REPLACE WITH YOUR ACTUAL APP ID
        // measurementId: "YOUR_MEASUREMENT_ID" // <--- REPLACE IF PROVIDED
      };

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);

      // Get service instances
      const auth = getAuth(app);
      const db = getFirestore(app);
      const functions = getFunctions(app); // Make sure you have deployed functions
      const storage = getStorage(app); // Initialize Firebase Storage

      // Make service instances globally available for other scripts (if not using modules everywhere)
      window.auth = auth;
      window.db = db;
      window.functions = functions;
      window.storage = storage; // Make storage instance globally available

      // Optional: Make specific Firebase functions global if needed in other scripts
      window.onAuthStateChanged = onAuthStateChanged;
      window.signInWithEmailAndPassword = signInWithEmailAndPassword;
      window.createUserWithEmailAndPassword = createUserWithEmailAndPassword;
      window.signOut = signOut;
      window.doc = doc; // Firestore doc reference
      window.getDoc = getDoc; // Firestore getDoc
      window.collection = collection; // Firestore collection reference
      window.query = query; // Firestore query
      window.where = where; // Firestore where clause
      window.orderBy = orderBy; // Firestore orderBy clause
      window.getDocs = getDocs; // Firestore getDocs
      window.runTransaction = runTransaction; // Firestore transaction
      window.httpsCallable = httpsCallable; // Functions httpsCallable
      window.setDoc = setDoc; // Make setDoc globally available (already imported but good for explicitness if other scripts use it)
      window.serverTimestamp = serverTimestamp; // Make serverTimestamp globally available

      // --- Basic Account Page Logic (can be moved to account.js) ---

      // Get references to key HTML elements
      const accountContent = document.getElementById("account-content");
      const authModal = document.getElementById("auth-modal");
      const loginFormContainer = document.getElementById(
        "login-form-container"
      );
      const registerFormContainer = document.getElementById(
        "register-form-container"
      );
      const loginForm = document.getElementById("login-form");
      const registerForm = document.getElementById("register-form");
      const authErrorMessage = document.getElementById("auth-error-message");
      const authRegErrorMessage = document.getElementById(
        "auth-reg-error-message"
      );
      const welcomeMessage = document.getElementById("welcome-message");
      const creditBalance = document.getElementById("credit-balance");
      const availableSlotsList = document.getElementById(
        "available-slots-list"
      );
      const logoutButton = document.getElementById("logout-button");

      // Elements for Purchase Credits Form
      const purchaseCreditsForm = document.getElementById(
        "purchase-credits-form"
      );
      const creditPackageSelect = document.getElementById("credit-package");
      const paymentProofInput = document.getElementById("payment-proof");
      const purchaseMessage = document.getElementById("purchase-message");
      const submitPurchaseButton = document.getElementById(
        "submit-purchase-request"
      );

      // Define package details (could also be fetched from Firestore)
      const creditPackages = {
        package1: { name: "10 Credits Pack", cost: 500, credits: 10 },
        package2: {
          name: "25 Credits Pack (10% off)",
          cost: 1125,
          credits: 25,
        },
        package3: {
          name: "50 Credits Pack (20% off)",
          cost: 2000,
          credits: 50,
        },
      };

      // Function to show the authentication modal
      function showAuthModal() {
        authModal.style.display = "flex"; // Use flex to center content
        loginFormContainer.style.display = "block"; // Default to showing login form
        registerFormContainer.style.display = "none";
        authErrorMessage.textContent = ""; // Clear any previous errors
        authRegErrorMessage.textContent = "";
      }

      // Function to hide the authentication modal
      function hideAuthModal() {
        authModal.style.display = "none";
      }

      // Function to toggle between login and registration forms
      document.querySelectorAll(".modal-toggle-link").forEach((link) => {
        link.addEventListener("click", function () {
          const targetId = this.dataset.target;
          if (targetId === "register-form-container") {
            loginFormContainer.style.display = "none";
            registerFormContainer.style.display = "block";
            authErrorMessage.textContent = ""; // Clear login errors when switching
          } else {
            registerFormContainer.style.display = "none";
            loginFormContainer.style.display = "block";
            authRegErrorMessage.textContent = ""; // Clear reg errors when switching
          }
          authErrorMessage.textContent = ""; // Clear errors on toggle
          authRegErrorMessage.textContent = "";
        });
      });

      // Handle Login Form Submission
      loginForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const email = loginForm.querySelector("#login-email").value;
        const password = loginForm.querySelector("#login-password").value;
        authErrorMessage.textContent = ""; // Clear previous errors

        try {
          await signInWithEmailAndPassword(auth, email, password);
          // onAuthStateChanged listener will handle UI update
        } catch (error) {
          console.error("Login Error:", error);
          // Display user-friendly error message
          switch (error.code) {
            case "auth/user-not-found":
              authErrorMessage.textContent = "No user found with this email.";
              break;
            case "auth/wrong-password":
              authErrorMessage.textContent = "Incorrect password.";
              break;
            case "auth/invalid-email":
              authErrorMessage.textContent = "Invalid email address format.";
              break;
            default:
              authErrorMessage.textContent = "Login failed. Please try again.";
          }
        }
      });

      // Handle Registration Form Submission
      registerForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const email = registerForm.querySelector("#register-email").value;
        const password = registerForm.querySelector("#register-password").value;
        const name = registerForm.querySelector("#register-name").value; // Optional name
        authRegErrorMessage.textContent = ""; // Clear previous errors

        try {
          const userCredential = await createUserWithEmailAndPassword(
            auth,
            email,
            password
          );
          const user = userCredential.user;

          // Create a user document in Firestore
          await setDoc(doc(db, "users", user.uid), {
            email: user.email,
            name: name || "", // Save name if provided
            credits: 0, // Initialize credits to 0
          });

          // onAuthStateChanged listener will handle UI update
        } catch (error) {
          console.error("Registration Error:", error);
          // Display user-friendly error message
          switch (error.code) {
            case "auth/email-already-in-use":
              authRegErrorMessage.textContent =
                "This email address is already in use.";
              break;
            case "auth/invalid-email":
              authRegErrorMessage.textContent = "Invalid email address format.";
              break;
            case "auth/weak-password":
              authRegErrorMessage.textContent =
                "Password should be at least 6 characters.";
              break;
            default:
              authRegErrorMessage.textContent =
                "Registration failed. Please try again.";
          }
        }
      });

      // Handle Logout Button Click
      logoutButton.addEventListener("click", async () => {
        try {
          await signOut(auth);
          // onAuthStateChanged listener will handle UI update
        } catch (error) {
          console.error("Logout Error:", error);
          alert("Logout failed. Please try again.");
        }
      });

      // Function to update UI for authenticated user
      async function updateUserUI(user) {
        accountContent.style.display = "block";
        hideAuthModal();
        welcomeMessage.textContent = `Welcome, ${user.email || "User"}!`; // Use email or a generic "User"

        // Fetch user data from Firestore
        if (user) {
          const userDocRef = doc(db, "users", user.uid);
          try {
            const docSnap = await getDoc(userDocRef);
            if (docSnap.exists()) {
              const userData = docSnap.data();
              creditBalance.textContent =
                userData.credits !== undefined ? userData.credits : 0;
              // You can also update welcome message with displayName if you store it
              // welcomeMessage.textContent = `Welcome, ${userData.displayName || user.email}!`;
            } else {
              // This case might occur if the user document wasn't created on registration
              // Or if this is the first login and it needs to be created.
              console.log(
                "User document does not exist. Displaying 0 credits."
              );
              creditBalance.textContent = 0;
              // Optionally, create the user document here if it's missing and it's expected to be.
              // For example, on first login after registration:
              // try {
              //   await setDoc(userDocRef, { email: user.email, credits: 0, createdAt: serverTimestamp() });
              //   console.log("User document created with initial credits.");
              // } catch (error) {
              //   console.error("Error creating user document on the fly:", error);
              // }
            }
          } catch (error) {
            console.error("Error fetching user data from Firestore:", error);
            creditBalance.textContent = "Error loading credits";
          }
        }
      }

      // Function to update UI for logged out user
      function updateUIAfterLogout() {
        accountContent.style.display = "none";
        showAuthModal();
        welcomeMessage.textContent = "Welcome, User!"; // Reset
        creditBalance.textContent = "Loading..."; // Reset
      }

      // --- Main Auth State Listener ---
      onAuthStateChanged(auth, (user) => {
        if (user) {
          // User is signed in.
          console.log("User signed in:", user.uid, user.email);
          updateUserUI(user);
          // Here you would typically load user-specific data, show account details, etc.
          // For example, fetch their credit balance, booking history.
        } else {
          // User is signed out.
          console.log("User signed out.");
          updateUIAfterLogout();
        }
      });

      // Handle Purchase Credits Form Submission
      if (purchaseCreditsForm) {
        purchaseCreditsForm.addEventListener("submit", async (e) => {
          e.preventDefault();
          const currentUser = auth.currentUser;
          if (!currentUser) {
            purchaseMessage.textContent =
              "You must be logged in to make a purchase.";
            purchaseMessage.style.color = "red";
            return;
          }

          const selectedPackageId = creditPackageSelect.value;
          const file = paymentProofInput.files[0];

          if (!selectedPackageId) {
            purchaseMessage.textContent = "Please select a credit package.";
            purchaseMessage.style.color = "red";
            return;
          }

          if (!file) {
            purchaseMessage.textContent = "Please upload a proof of payment.";
            purchaseMessage.style.color = "red";
            return;
          }

          submitPurchaseButton.disabled = true;
          purchaseMessage.textContent = "Processing your request...";
          purchaseMessage.style.color = "blue";

          try {
            // 1. Upload file to Firebase Storage
            const filePath = `purchase_proofs/${
              currentUser.uid
            }/${Date.now()}_${file.name}`;
            const fileRef = storageRef(storage, filePath);
            const uploadTask = uploadBytesResumable(fileRef, file);

            // Listen for state changes, errors, and completion of the upload.
            uploadTask.on(
              "state_changed",
              (snapshot) => {
                const progress =
                  (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                purchaseMessage.textContent =
                  "Upload is " + progress.toFixed(0) + "% done";
              },
              (error) => {
                console.error("Upload failed:", error);
                purchaseMessage.textContent =
                  "File upload failed. Please try again.";
                purchaseMessage.style.color = "red";
                submitPurchaseButton.disabled = false;
              },
              async () => {
                // Upload completed successfully, now get the download URL
                const downloadURL = await getDownloadURL(
                  uploadTask.snapshot.ref
                );
                console.log("File available at", downloadURL);

                // 2. Create purchase request document in Firestore
                const packageDetails = creditPackages[selectedPackageId];
                const purchaseRequestRef = doc(
                  collection(db, "purchaseRequests")
                ); // Auto-generate ID

                await setDoc(purchaseRequestRef, {
                  userId: currentUser.uid,
                  userEmail: currentUser.email, // Storing email for admin convenience
                  packageId: selectedPackageId,
                  packageName: packageDetails.name,
                  packageCost: packageDetails.cost,
                  creditsToGrant: packageDetails.credits,
                  proofOfPaymentUrl: downloadURL,
                  status: "pending_review",
                  requestedAt: serverTimestamp(), // Make sure serverTimestamp is imported from firestore
                });

                purchaseMessage.textContent =
                  "Purchase request submitted successfully! Admin will review it shortly.";
                purchaseMessage.style.color = "green";
                purchaseCreditsForm.reset(); // Reset the form
                submitPurchaseButton.disabled = false;
              }
            );
          } catch (error) {
            console.error("Error submitting purchase request:", error);
            purchaseMessage.textContent =
              "Error submitting request. Please try again.";
            purchaseMessage.style.color = "red";
            submitPurchaseButton.disabled = false;
          }
        });
      }
    </script>

    <!--
        Link to your custom JavaScript file for additional account page logic.
        This script will run after the Firebase initialization script.
        If you move the functions from the script tag above into account.js,
        make sure account.js is loaded as a type="module" and imports
        the necessary Firebase functions or uses the global window variables.
     -->
    <!-- <script src="scripts/account.js" type="module"></script> -->
    <!-- OR if not using modules in account.js: -->
    <!-- <script src="scripts/account.js"></script> -->
  </body>
</html>
